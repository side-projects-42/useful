!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).Typeson=e.Typeson||{},e.Typeson.presets=e.Typeson.presets||{},e.Typeson.presets.undef=t())}(this,function(){"use strict";var e=[{sparseArrays:{testPlainObjects:!0,test:function test(e){return Array.isArray(e)},replace:function replace(e,t){return t.iterateUnsetNumeric=!0,e}}},{sparseUndefined:{test:function test(e,t){return void 0===e&&!1===t.ownKeys},replace:function replace(e){return 0},revive:function revive(e){}}}];function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _typeof$1(e){return(_typeof$1="function"==typeof Symbol&&"symbol"===_typeof(Symbol.iterator)?function _typeof$1(e){return _typeof(e)}:function _typeof$1(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":_typeof(e)})(e)}function asyncGeneratorStep(e,t,n,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function _next(e){asyncGeneratorStep(o,r,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(o,r,i,_next,_throw,"throw",e)}_next(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return n}(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var t=function TypesonPromise(e){_classCallCheck(this,TypesonPromise),this.p=new Promise(e)};"undefined"!=typeof Symbol&&(t.prototype[Symbol.toStringTag]="TypesonPromise"),t.prototype.then=function(e,n){var r=this;return new t(function(t,i){r.p.then(function(n){t(e?e(n):n)},function(e){r.p.catch(function(e){return n?n(e):Promise.reject(e)}).then(t,i)})})},t.prototype.catch=function(e){return this.then(null,e)},t.resolve=function(e){return new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},["all","race"].map(function(e){t[e]=function(n){return new t(function(t,r){Promise[e](n.map(function(e){return e.p})).then(t,r)})}});var n={}.toString,r={}.hasOwnProperty,i=Object.getPrototypeOf,o=r.toString;function isThenable(e,t){return isObject(e)&&"function"==typeof e.then&&(!t||"function"==typeof e.catch)}function toStringTag(e){return n.call(e).slice(8,-1)}function hasConstructorOf(e,t){if(!e||"object"!==_typeof$1(e))return!1;var n=i(e);if(!n)return!1;var a=r.call(n,"constructor")&&n.constructor;return"function"!=typeof a?null===t:"function"==typeof a&&null!==t&&o.call(a)===o.call(t)}function isPlainObject(e){return!(!e||"Object"!==toStringTag(e))&&(!i(e)||hasConstructorOf(e,Object))}function isObject(e){return e&&"object"===_typeof$1(e)}function escapeKeyPathComponent(e){return e.replace(/~/g,"~0").replace(/\./g,"~1")}function unescapeKeyPathComponent(e){return e.replace(/~1/g,".").replace(/~0/g,"~")}function getByKeyPath(e,t){if(""===t)return e;var n=t.indexOf(".");if(n>-1){var r=e[unescapeKeyPathComponent(t.substr(0,n))];return void 0===r?void 0:getByKeyPath(r,t.substr(n+1))}return e[unescapeKeyPathComponent(t)]}var a=Object.keys,c=Array.isArray,s={}.hasOwnProperty,u=["type","replaced","iterateIn","iterateUnsetNumeric"];function nestedPathsFirst(e,t){var n=e.keypath.match(/\./g),r=e.keypath.match(/\./g);return n&&(n=n.length),r&&(r=r.length),n>r?-1:n<r?1:e.keypath<t.keypath?-1:e.keypath>t.keypath}var p=function(){function Typeson(e){_classCallCheck(this,Typeson),this.options=e,this.plainObjectReplacers=[],this.nonplainObjectReplacers=[],this.revivers={},this.types={}}return function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}(Typeson,[{key:"stringify",value:function stringify(e,t,n,r){r=_objectSpread({},this.options,r,{stringification:!0});var i=this.encapsulate(e,null,r);return c(i)?JSON.stringify(i[0],t,n):i.then(function(e){return JSON.stringify(e,t,n)})}},{key:"stringifySync",value:function stringifySync(e,t,n,r){return this.stringify(e,t,n,_objectSpread({throwOnBadSyncType:!0},r,{sync:!0}))}},{key:"stringifyAsync",value:function stringifyAsync(e,t,n,r){return this.stringify(e,t,n,_objectSpread({throwOnBadSyncType:!0},r,{sync:!1}))}},{key:"parse",value:function parse(e,t,n){return n=_objectSpread({},this.options,n,{parse:!0}),this.revive(JSON.parse(e,t),n)}},{key:"parseSync",value:function parseSync(e,t,n){return this.parse(e,t,_objectSpread({throwOnBadSyncType:!0},n,{sync:!0}))}},{key:"parseAsync",value:function parseAsync(e,t,n){return this.parse(e,t,_objectSpread({throwOnBadSyncType:!0},n,{sync:!1}))}},{key:"specialTypeNames",value:function specialTypeNames(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.returnTypeNames=!0,this.encapsulate(e,t,n)}},{key:"rootTypeName",value:function rootTypeName(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.iterateNone=!0,this.encapsulate(e,t,n)}},{key:"encapsulate",value:function encapsulate(e,n,r){var i=(r=_objectSpread({sync:!0},this.options,r)).sync,o=this,p={},y=[],l=[],f=[],h=!("cyclic"in r)||r.cyclic,v=r.encapsulateObserver,d=_encapsulate("",e,h,n||{},f);function finish(e){var t=Object.values(p);if(r.iterateNone)return t.length?t[0]:Typeson.getJSONType(e);if(t.length){if(r.returnTypeNames)return _toConsumableArray(new Set(t));e&&isPlainObject(e)&&!s.call(e,"$types")?e.$types=p:e={$:e,$types:{$:p}}}else isObject(e)&&s.call(e,"$types")&&(e={$:e,$types:!0});return!r.returnTypeNames&&e}function checkPromises(e,t){return _checkPromises.apply(this,arguments)}function _checkPromises(){return(_checkPromises=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(e,n){var r;return regeneratorRuntime.wrap(function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Promise.all(n.map(function(e){return e[1].p}));case 2:return r=i.sent,i.next=5,Promise.all(r.map(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function _callee(r){var i,o,a,c,s,u,p,y,l,f,h,v,d,b;return regeneratorRuntime.wrap(function _callee$(O){for(;;)switch(O.prev=O.next){case 0:if(i=[],o=n.splice(0,1),a=_slicedToArray(o,1),c=a[0],s=_slicedToArray(c,7),u=s[0],p=s[2],y=s[3],l=s[4],f=s[5],h=s[6],v=_encapsulate(u,r,p,y,i,!0,h),d=hasConstructorOf(v,t),!u||!d){O.next=11;break}return O.next=8,v.p;case 8:return b=O.sent,l[f]=b,O.abrupt("return",checkPromises(e,i));case 11:return u?l[f]=v:e=d?v.p:v,O.abrupt("return",checkPromises(e,i));case 13:case"end":return O.stop()}},_callee)}));return function(e){return r.apply(this,arguments)}}()));case 5:return i.abrupt("return",e);case 6:case"end":return i.stop()}},_callee2)}))).apply(this,arguments)}function _adaptBuiltinStateObjectProperties(e,t,n){Object.assign(e,t);var r=u.map(function(t){var n=e[t];return delete e[t],n});n(),u.forEach(function(t,n){e[t]=r[n]})}function _encapsulate(e,n,i,u,f,h,d){var b,O={},m=_typeof$1(n),g=v?function(r){var o=d||u.type||Typeson.getJSONType(n);v(Object.assign(r||O,{keypath:e,value:n,cyclic:i,stateObj:u,promisesData:f,resolvingTypesonPromise:h,awaitingTypesonPromise:hasConstructorOf(n,t)},void 0!==o?{type:o}:{}))}:null;if(["string","boolean","number","undefined"].includes(m))return void 0===n||"number"===m&&(isNaN(n)||n===-1/0||n===1/0)?(b=replace(e,n,u,f,!1,h,g))!==n&&(O={replaced:b}):b=n,g&&g(),b;if(null===n)return g&&g(),n;if(i&&!u.iterateIn&&!u.iterateUnsetNumeric){var _=y.indexOf(n);if(!(_<0))return p[e]="#",g&&g({cyclicKeypath:l[_]}),"#"+l[_];!0===i&&(y.push(n),l.push(e))}var S,j=isPlainObject(n),P=c(n),T=(j||P)&&(!o.plainObjectReplacers.length||u.replaced)||u.iterateIn?n:replace(e,n,u,f,j||P,null,g);if(T!==n?(b=T,O={replaced:T}):P&&"object"!==u.iterateIn||"array"===u.iterateIn?(S=new Array(n.length),O={clone:S}):j||"object"===u.iterateIn?(S={},u.addLength&&(S.length=n.length),O={clone:S}):""===e&&hasConstructorOf(n,t)?(f.push([e,n,i,u,void 0,void 0,u.type]),b=n):b=n,g&&g(),r.iterateNone)return S||b;if(!S)return b;if(u.iterateIn){var w=function _loop(r){var o={ownKeys:s.call(n,r)};_adaptBuiltinStateObjectProperties(u,o,function(){var o=e+(e?".":"")+escapeKeyPathComponent(r),a=_encapsulate(o,n[r],!!i,u,f,h);hasConstructorOf(a,t)?f.push([o,a,!!i,u,S,r,u.type]):void 0!==a&&(S[r]=a)})};for(var A in n)w(A);g&&g({endIterateIn:!0,end:!0})}else a(n).forEach(function(r){var o=e+(e?".":"")+escapeKeyPathComponent(r);_adaptBuiltinStateObjectProperties(u,{ownKeys:!0},function(){var e=_encapsulate(o,n[r],!!i,u,f,h);hasConstructorOf(e,t)?f.push([o,e,!!i,u,S,r,u.type]):void 0!==e&&(S[r]=e)})}),g&&g({endIterateOwn:!0,end:!0});if(u.iterateUnsetNumeric){for(var k=n.length,C=function _loop2(r){if(!(r in n)){var o=e+(e?".":"")+r;_adaptBuiltinStateObjectProperties(u,{ownKeys:!1},function(){var e=_encapsulate(o,void 0,!!i,u,f,h);hasConstructorOf(e,t)?f.push([o,e,!!i,u,S,r,u.type]):void 0!==e&&(S[r]=e)})}},K=0;K<k;K++)C(K);g&&g({endIterateUnsetNumeric:!0,end:!0})}return S}function replace(e,t,n,r,a,c,s){for(var u=a?o.plainObjectReplacers:o.nonplainObjectReplacers,y=u.length;y--;){var l=u[y];if(l.test(t,n)){var f=l.type;if(o.revivers[f]){var v=p[e];p[e]=v?[f].concat(v):f}return Object.assign(n,{type:f,replaced:!0}),!i&&l.replaceAsync||l.replace?(s&&s({replacing:!0}),_encapsulate(e,l[i||!l.replaceAsync?"replace":"replaceAsync"](t,n),h&&"readonly",n,r,c,f)):(s&&s({typeDetected:!0}),_encapsulate(e,t,h&&"readonly",n,r,c,f))}}return t}return f.length?i&&r.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():Promise.resolve(checkPromises(d,f)).then(finish):!i&&r.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():r.stringification&&i?[finish(d)]:i?finish(d):Promise.resolve(finish(d))}},{key:"encapsulateSync",value:function encapsulateSync(e,t,n){return this.encapsulate(e,t,_objectSpread({throwOnBadSyncType:!0},n,{sync:!0}))}},{key:"encapsulateAsync",value:function encapsulateAsync(e,t,n){return this.encapsulate(e,t,_objectSpread({throwOnBadSyncType:!0},n,{sync:!1}))}},{key:"revive",value:function revive(e,n){var r=e&&e.$types;if(!r)return e;if(!0===r)return e.$;var i=(n=_objectSpread({sync:!0},this.options,n)).sync,o=[],s={},u=!0;r.$&&isPlainObject(r.$)&&(e=e.$,r=r.$,u=!1);var p=this;function _revive(e,n,l,f,h){if(!u||"$types"!==e){var v=r[e];if(c(n)||isPlainObject(n)){var d=c(n)?new Array(n.length):{};for(a(n).forEach(function(t){var r=_revive(e+(e?".":"")+escapeKeyPathComponent(t),n[t],l||d,d,t);hasConstructorOf(r,y)?d[t]=void 0:void 0!==r&&(d[t]=r)}),n=d;o.length;){var b=_slicedToArray(o[0],4),O=b[0],m=b[1],g=b[2],_=b[3],S=getByKeyPath(O,m);if(hasConstructorOf(S,y))g[_]=void 0;else{if(void 0===S)break;g[_]=S}o.splice(0,1)}}if(!v)return n;if("#"===v){var j=getByKeyPath(l,n.slice(1));return void 0===j&&o.push([l,n.slice(1),f,h]),j}return[].concat(v).reduce(function reducer(e,n){if(hasConstructorOf(e,t))return e.then(function(e){return reducer(e,n)});var r=_slicedToArray(p.revivers[n],1)[0];if(!r)throw new Error("Unregistered type: "+n);return r[i&&r.revive?"revive":!i&&r.reviveAsync?"reviveAsync":"revive"](e,s)},n)}}function checkUndefined(e){return hasConstructorOf(e,y)?void 0:e}var l,f=function revivePlainObjects(){var n=[];if(Object.entries(r).forEach(function(e){var t=_slicedToArray(e,2),i=t[0],o=t[1];"#"!==o&&[].concat(o).forEach(function(e){_slicedToArray(p.revivers[e],2)[1].plain&&(n.push({keypath:i,type:e}),delete r[i])})}),n.length)return n.sort(nestedPathsFirst).reduce(function reducer(n,r){var o=r.keypath,a=r.type;if(hasConstructorOf(n,t))return n.then(function(e){return reducer(e,a)});var c=getByKeyPath(e,o);if(hasConstructorOf(c,t))return c.then(function(e){return reducer(e,a)});var u=_slicedToArray(p.revivers[a],1)[0];if(!u)throw new Error("Unregistered type: "+a);void 0!==(c=u[i&&u.revive?"revive":!i&&u.reviveAsync?"reviveAsync":"revive"](c,s))&&(hasConstructorOf(c,y)&&(c=void 0),function setAtKeyPath(e,t,n){if(""===t)return n;var r=t.indexOf(".");return r>-1?setAtKeyPath(e[unescapeKeyPathComponent(t.substr(0,r))],t.substr(r+1),n):(e[unescapeKeyPathComponent(t)]=n,e)}(e,o,c)===c&&(e=c))},void 0)}();return isThenable(l=hasConstructorOf(f,t)?f.then(function(){return _revive("",e,null)}):_revive("",e,null))?i&&n.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():hasConstructorOf(l,t)?l.p.then(checkUndefined):l:!i&&n.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():i?checkUndefined(l):Promise.resolve(checkUndefined(l))}},{key:"reviveSync",value:function reviveSync(e,t){return this.revive(e,_objectSpread({throwOnBadSyncType:!0},t,{sync:!0}))}},{key:"reviveAsync",value:function reviveAsync(e,t){return this.revive(e,_objectSpread({throwOnBadSyncType:!0},t,{sync:!1}))}},{key:"register",value:function register(e,t){return t=t||{},[].concat(e).forEach(function R(e){if(c(e))return e.map(R,this);e&&a(e).forEach(function(n){if("#"===n)throw new TypeError("# cannot be used as a type name as it is reserved for cyclic objects");if(Typeson.JSON_TYPES.includes(n))throw new TypeError("Plain JSON object types are reserved as type names");var r=e[n],i=r.testPlainObjects?this.plainObjectReplacers:this.nonplainObjectReplacers,o=i.filter(function(e){return e.type===n});if(o.length&&(i.splice(i.indexOf(o[0]),1),delete this.revivers[n],delete this.types[n]),r){if("function"==typeof r){var a=r;r={test:function test(e){return e&&e.constructor===a},replace:function replace(e){return Object.assign({},e)},revive:function revive(e){return Object.assign(Object.create(a.prototype),e)}}}else if(c(r)){var s=_slicedToArray(r,3);r={test:s[0],replace:s[1],revive:s[2]}}var u={type:n,test:r.test.bind(r)};r.replace&&(u.replace=r.replace.bind(r)),r.replaceAsync&&(u.replaceAsync=r.replaceAsync.bind(r));var p="number"==typeof t.fallback?t.fallback:t.fallback?0:1/0;if(r.testPlainObjects?this.plainObjectReplacers.splice(p,0,u):this.nonplainObjectReplacers.splice(p,0,u),r.revive||r.reviveAsync){var y={};r.revive&&(y.revive=r.revive.bind(r)),r.reviveAsync&&(y.reviveAsync=r.reviveAsync.bind(r)),this.revivers[n]=[y,{plain:r.testPlainObjects}]}this.types[n]=r}},this)},this),this}}]),Typeson}(),y=function Undefined(){_classCallCheck(this,Undefined)};return p.Undefined=y,p.Promise=t,p.isThenable=isThenable,p.toStringTag=toStringTag,p.hasConstructorOf=hasConstructorOf,p.isObject=isObject,p.isPlainObject=isPlainObject,p.isUserObject=function isUserObject(e){if(!e||"Object"!==toStringTag(e))return!1;var t=i(e);return!t||hasConstructorOf(e,Object)||isUserObject(t)},p.escapeKeyPathComponent=escapeKeyPathComponent,p.unescapeKeyPathComponent=unescapeKeyPathComponent,p.getByKeyPath=getByKeyPath,p.getJSONType=function getJSONType(e){return null===e?"null":Array.isArray(e)?"array":_typeof$1(e)},p.JSON_TYPES=["null","boolean","number","string","array","object"],[e,{undef:{test:function test(e,t){return void 0===e&&(t.ownKeys||!("ownKeys"in t))},replace:function replace(e){return 0},revive:function revive(e){return new p.Undefined}}}]});
//# sourceMappingURL=undef.js.map
