!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).Typeson=e.Typeson||{},e.Typeson.presets=e.Typeson.presets||{},e.Typeson.presets.postmessage=t())}(this,function(){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _typeof$1(e){return(_typeof$1="function"==typeof Symbol&&"symbol"===_typeof(Symbol.iterator)?function _typeof$1(e){return _typeof(e)}:function _typeof$1(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":_typeof(e)})(e)}function asyncGeneratorStep(e,t,r,n,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var i=e.apply(t,r);function _next(e){asyncGeneratorStep(i,n,o,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(i,n,o,_next,_throw,"throw",e)}_next(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw i}}return r}(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var e=function TypesonPromise(e){_classCallCheck(this,TypesonPromise),this.p=new Promise(e)};"undefined"!=typeof Symbol&&(e.prototype[Symbol.toStringTag]="TypesonPromise"),e.prototype.then=function(t,r){var n=this;return new e(function(e,o){n.p.then(function(r){e(t?t(r):r)},function(t){n.p.catch(function(e){return r?r(e):Promise.reject(e)}).then(e,o)})})},e.prototype.catch=function(e){return this.then(null,e)},e.resolve=function(t){return new e(function(e){e(t)})},e.reject=function(t){return new e(function(e,r){r(t)})},["all","race"].map(function(t){e[t]=function(r){return new e(function(e,n){Promise[t](r.map(function(e){return e.p})).then(e,n)})}});var t={}.toString,r={}.hasOwnProperty,n=Object.getPrototypeOf,o=r.toString;function isThenable(e,t){return isObject(e)&&"function"==typeof e.then&&(!t||"function"==typeof e.catch)}function toStringTag(e){return t.call(e).slice(8,-1)}function hasConstructorOf(e,t){if(!e||"object"!==_typeof$1(e))return!1;var i=n(e);if(!i)return!1;var a=r.call(i,"constructor")&&i.constructor;return"function"!=typeof a?null===t:"function"==typeof a&&null!==t&&o.call(a)===o.call(t)}function isPlainObject(e){return!(!e||"Object"!==toStringTag(e))&&(!n(e)||hasConstructorOf(e,Object))}function isObject(e){return e&&"object"===_typeof$1(e)}function escapeKeyPathComponent(e){return e.replace(/~/g,"~0").replace(/\./g,"~1")}function unescapeKeyPathComponent(e){return e.replace(/~1/g,".").replace(/~0/g,"~")}function getByKeyPath(e,t){if(""===t)return e;var r=t.indexOf(".");if(r>-1){var n=e[unescapeKeyPathComponent(t.substr(0,r))];return void 0===n?void 0:getByKeyPath(n,t.substr(r+1))}return e[unescapeKeyPathComponent(t)]}var i=Object.keys,a=Array.isArray,c={}.hasOwnProperty,s=["type","replaced","iterateIn","iterateUnsetNumeric"];function nestedPathsFirst(e,t){var r=e.keypath.match(/\./g),n=e.keypath.match(/\./g);return r&&(r=r.length),n&&(n=n.length),r>n?-1:r<n?1:e.keypath<t.keypath?-1:e.keypath>t.keypath}var u=function(){function Typeson(e){_classCallCheck(this,Typeson),this.options=e,this.plainObjectReplacers=[],this.nonplainObjectReplacers=[],this.revivers={},this.types={}}return function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}(Typeson,[{key:"stringify",value:function stringify(e,t,r,n){n=_objectSpread({},this.options,n,{stringification:!0});var o=this.encapsulate(e,null,n);return a(o)?JSON.stringify(o[0],t,r):o.then(function(e){return JSON.stringify(e,t,r)})}},{key:"stringifySync",value:function stringifySync(e,t,r,n){return this.stringify(e,t,r,_objectSpread({throwOnBadSyncType:!0},n,{sync:!0}))}},{key:"stringifyAsync",value:function stringifyAsync(e,t,r,n){return this.stringify(e,t,r,_objectSpread({throwOnBadSyncType:!0},n,{sync:!1}))}},{key:"parse",value:function parse(e,t,r){return r=_objectSpread({},this.options,r,{parse:!0}),this.revive(JSON.parse(e,t),r)}},{key:"parseSync",value:function parseSync(e,t,r){return this.parse(e,t,_objectSpread({throwOnBadSyncType:!0},r,{sync:!0}))}},{key:"parseAsync",value:function parseAsync(e,t,r){return this.parse(e,t,_objectSpread({throwOnBadSyncType:!0},r,{sync:!1}))}},{key:"specialTypeNames",value:function specialTypeNames(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.returnTypeNames=!0,this.encapsulate(e,t,r)}},{key:"rootTypeName",value:function rootTypeName(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.iterateNone=!0,this.encapsulate(e,t,r)}},{key:"encapsulate",value:function encapsulate(t,r,n){var o=(n=_objectSpread({sync:!0},this.options,n)).sync,u=this,p={},y=[],l=[],f=[],h=!("cyclic"in n)||n.cyclic,v=n.encapsulateObserver,d=_encapsulate("",t,h,r||{},f);function finish(e){var t=Object.values(p);if(n.iterateNone)return t.length?t[0]:Typeson.getJSONType(e);if(t.length){if(n.returnTypeNames)return _toConsumableArray(new Set(t));e&&isPlainObject(e)&&!c.call(e,"$types")?e.$types=p:e={$:e,$types:{$:p}}}else isObject(e)&&c.call(e,"$types")&&(e={$:e,$types:!0});return!n.returnTypeNames&&e}function checkPromises(e,t){return _checkPromises.apply(this,arguments)}function _checkPromises(){return(_checkPromises=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(t,r){var n;return regeneratorRuntime.wrap(function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,Promise.all(r.map(function(e){return e[1].p}));case 2:return n=o.sent,o.next=5,Promise.all(n.map(function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function _callee(n){var o,i,a,c,s,u,p,y,l,f,h,v,d,b;return regeneratorRuntime.wrap(function _callee$(m){for(;;)switch(m.prev=m.next){case 0:if(o=[],i=r.splice(0,1),a=_slicedToArray(i,1),c=a[0],s=_slicedToArray(c,7),u=s[0],p=s[2],y=s[3],l=s[4],f=s[5],h=s[6],v=_encapsulate(u,n,p,y,o,!0,h),d=hasConstructorOf(v,e),!u||!d){m.next=11;break}return m.next=8,v.p;case 8:return b=m.sent,l[f]=b,m.abrupt("return",checkPromises(t,o));case 11:return u?l[f]=v:t=d?v.p:v,m.abrupt("return",checkPromises(t,o));case 13:case"end":return m.stop()}},_callee)}));return function(e){return n.apply(this,arguments)}}()));case 5:return o.abrupt("return",t);case 6:case"end":return o.stop()}},_callee2)}))).apply(this,arguments)}function _adaptBuiltinStateObjectProperties(e,t,r){Object.assign(e,t);var n=s.map(function(t){var r=e[t];return delete e[t],r});r(),s.forEach(function(t,r){e[t]=n[r]})}function _encapsulate(t,r,o,s,f,h,d){var b,m={},O=_typeof$1(r),g=v?function(n){var i=d||s.type||Typeson.getJSONType(r);v(Object.assign(n||m,{keypath:t,value:r,cyclic:o,stateObj:s,promisesData:f,resolvingTypesonPromise:h,awaitingTypesonPromise:hasConstructorOf(r,e)},void 0!==i?{type:i}:{}))}:null;if(["string","boolean","number","undefined"].includes(O))return void 0===r||"number"===O&&(isNaN(r)||r===-1/0||r===1/0)?(b=replace(t,r,s,f,!1,h,g))!==r&&(m={replaced:b}):b=r,g&&g(),b;if(null===r)return g&&g(),r;if(o&&!s.iterateIn&&!s.iterateUnsetNumeric){var _=y.indexOf(r);if(!(_<0))return p[t]="#",g&&g({cyclicKeypath:l[_]}),"#"+l[_];!0===o&&(y.push(r),l.push(t))}var S,j=isPlainObject(r),P=a(r),T=(j||P)&&(!u.plainObjectReplacers.length||s.replaced)||s.iterateIn?r:replace(t,r,s,f,j||P,null,g);if(T!==r?(b=T,m={replaced:T}):P&&"object"!==s.iterateIn||"array"===s.iterateIn?(S=new Array(r.length),m={clone:S}):j||"object"===s.iterateIn?(S={},s.addLength&&(S.length=r.length),m={clone:S}):""===t&&hasConstructorOf(r,e)?(f.push([t,r,o,s,void 0,void 0,s.type]),b=r):b=r,g&&g(),n.iterateNone)return S||b;if(!S)return b;if(s.iterateIn){var w=function _loop(n){var i={ownKeys:c.call(r,n)};_adaptBuiltinStateObjectProperties(s,i,function(){var i=t+(t?".":"")+escapeKeyPathComponent(n),a=_encapsulate(i,r[n],!!o,s,f,h);hasConstructorOf(a,e)?f.push([i,a,!!o,s,S,n,s.type]):void 0!==a&&(S[n]=a)})};for(var A in r)w(A);g&&g({endIterateIn:!0,end:!0})}else i(r).forEach(function(n){var i=t+(t?".":"")+escapeKeyPathComponent(n);_adaptBuiltinStateObjectProperties(s,{ownKeys:!0},function(){var t=_encapsulate(i,r[n],!!o,s,f,h);hasConstructorOf(t,e)?f.push([i,t,!!o,s,S,n,s.type]):void 0!==t&&(S[n]=t)})}),g&&g({endIterateOwn:!0,end:!0});if(s.iterateUnsetNumeric){for(var k=r.length,C=function _loop2(n){if(!(n in r)){var i=t+(t?".":"")+n;_adaptBuiltinStateObjectProperties(s,{ownKeys:!1},function(){var t=_encapsulate(i,void 0,!!o,s,f,h);hasConstructorOf(t,e)?f.push([i,t,!!o,s,S,n,s.type]):void 0!==t&&(S[n]=t)})}},E=0;E<k;E++)C(E);g&&g({endIterateUnsetNumeric:!0,end:!0})}return S}function replace(e,t,r,n,i,a,c){for(var s=i?u.plainObjectReplacers:u.nonplainObjectReplacers,y=s.length;y--;){var l=s[y];if(l.test(t,r)){var f=l.type;if(u.revivers[f]){var v=p[e];p[e]=v?[f].concat(v):f}return Object.assign(r,{type:f,replaced:!0}),!o&&l.replaceAsync||l.replace?(c&&c({replacing:!0}),_encapsulate(e,l[o||!l.replaceAsync?"replace":"replaceAsync"](t,r),h&&"readonly",r,n,a,f)):(c&&c({typeDetected:!0}),_encapsulate(e,t,h&&"readonly",r,n,a,f))}}return t}return f.length?o&&n.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():Promise.resolve(checkPromises(d,f)).then(finish):!o&&n.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():n.stringification&&o?[finish(d)]:o?finish(d):Promise.resolve(finish(d))}},{key:"encapsulateSync",value:function encapsulateSync(e,t,r){return this.encapsulate(e,t,_objectSpread({throwOnBadSyncType:!0},r,{sync:!0}))}},{key:"encapsulateAsync",value:function encapsulateAsync(e,t,r){return this.encapsulate(e,t,_objectSpread({throwOnBadSyncType:!0},r,{sync:!1}))}},{key:"revive",value:function revive(t,r){var n=t&&t.$types;if(!n)return t;if(!0===n)return t.$;var o=(r=_objectSpread({sync:!0},this.options,r)).sync,c=[],s={},u=!0;n.$&&isPlainObject(n.$)&&(t=t.$,n=n.$,u=!1);var y=this;function _revive(t,r,l,f,h){if(!u||"$types"!==t){var v=n[t];if(a(r)||isPlainObject(r)){var d=a(r)?new Array(r.length):{};for(i(r).forEach(function(e){var n=_revive(t+(t?".":"")+escapeKeyPathComponent(e),r[e],l||d,d,e);hasConstructorOf(n,p)?d[e]=void 0:void 0!==n&&(d[e]=n)}),r=d;c.length;){var b=_slicedToArray(c[0],4),m=b[0],O=b[1],g=b[2],_=b[3],S=getByKeyPath(m,O);if(hasConstructorOf(S,p))g[_]=void 0;else{if(void 0===S)break;g[_]=S}c.splice(0,1)}}if(!v)return r;if("#"===v){var j=getByKeyPath(l,r.slice(1));return void 0===j&&c.push([l,r.slice(1),f,h]),j}return[].concat(v).reduce(function reducer(t,r){if(hasConstructorOf(t,e))return t.then(function(e){return reducer(e,r)});var n=_slicedToArray(y.revivers[r],1)[0];if(!n)throw new Error("Unregistered type: "+r);return n[o&&n.revive?"revive":!o&&n.reviveAsync?"reviveAsync":"revive"](t,s)},r)}}function checkUndefined(e){return hasConstructorOf(e,p)?void 0:e}var l,f=function revivePlainObjects(){var r=[];if(Object.entries(n).forEach(function(e){var t=_slicedToArray(e,2),o=t[0],i=t[1];"#"!==i&&[].concat(i).forEach(function(e){_slicedToArray(y.revivers[e],2)[1].plain&&(r.push({keypath:o,type:e}),delete n[o])})}),r.length)return r.sort(nestedPathsFirst).reduce(function reducer(r,n){var i=n.keypath,a=n.type;if(hasConstructorOf(r,e))return r.then(function(e){return reducer(e,a)});var c=getByKeyPath(t,i);if(hasConstructorOf(c,e))return c.then(function(e){return reducer(e,a)});var u=_slicedToArray(y.revivers[a],1)[0];if(!u)throw new Error("Unregistered type: "+a);void 0!==(c=u[o&&u.revive?"revive":!o&&u.reviveAsync?"reviveAsync":"revive"](c,s))&&(hasConstructorOf(c,p)&&(c=void 0),function setAtKeyPath(e,t,r){if(""===t)return r;var n=t.indexOf(".");return n>-1?setAtKeyPath(e[unescapeKeyPathComponent(t.substr(0,n))],t.substr(n+1),r):(e[unescapeKeyPathComponent(t)]=r,e)}(t,i,c)===c&&(t=c))},void 0)}();return isThenable(l=hasConstructorOf(f,e)?f.then(function(){return _revive("",t,null)}):_revive("",t,null))?o&&r.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():hasConstructorOf(l,e)?l.p.then(checkUndefined):l:!o&&r.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():o?checkUndefined(l):Promise.resolve(checkUndefined(l))}},{key:"reviveSync",value:function reviveSync(e,t){return this.revive(e,_objectSpread({throwOnBadSyncType:!0},t,{sync:!0}))}},{key:"reviveAsync",value:function reviveAsync(e,t){return this.revive(e,_objectSpread({throwOnBadSyncType:!0},t,{sync:!1}))}},{key:"register",value:function register(e,t){return t=t||{},[].concat(e).forEach(function R(e){if(a(e))return e.map(R,this);e&&i(e).forEach(function(r){if("#"===r)throw new TypeError("# cannot be used as a type name as it is reserved for cyclic objects");if(Typeson.JSON_TYPES.includes(r))throw new TypeError("Plain JSON object types are reserved as type names");var n=e[r],o=n.testPlainObjects?this.plainObjectReplacers:this.nonplainObjectReplacers,i=o.filter(function(e){return e.type===r});if(i.length&&(o.splice(o.indexOf(i[0]),1),delete this.revivers[r],delete this.types[r]),n){if("function"==typeof n){var c=n;n={test:function test(e){return e&&e.constructor===c},replace:function replace(e){return Object.assign({},e)},revive:function revive(e){return Object.assign(Object.create(c.prototype),e)}}}else if(a(n)){var s=_slicedToArray(n,3);n={test:s[0],replace:s[1],revive:s[2]}}var u={type:r,test:n.test.bind(n)};n.replace&&(u.replace=n.replace.bind(n)),n.replaceAsync&&(u.replaceAsync=n.replaceAsync.bind(n));var p="number"==typeof t.fallback?t.fallback:t.fallback?0:1/0;if(n.testPlainObjects?this.plainObjectReplacers.splice(p,0,u):this.nonplainObjectReplacers.splice(p,0,u),n.revive||n.reviveAsync){var y={};n.revive&&(y.revive=n.revive.bind(n)),n.reviveAsync&&(y.reviveAsync=n.reviveAsync.bind(n)),this.revivers[r]=[y,{plain:n.testPlainObjects}]}this.types[r]=n}},this)},this),this}}]),Typeson}(),p=function Undefined(){_classCallCheck(this,Undefined)};u.Undefined=p,u.Promise=e,u.isThenable=isThenable,u.toStringTag=toStringTag,u.hasConstructorOf=hasConstructorOf,u.isObject=isObject,u.isPlainObject=isPlainObject,u.isUserObject=function isUserObject(e){if(!e||"Object"!==toStringTag(e))return!1;var t=n(e);return!t||hasConstructorOf(e,Object)||isUserObject(t)},u.escapeKeyPathComponent=escapeKeyPathComponent,u.unescapeKeyPathComponent=unescapeKeyPathComponent,u.getByKeyPath=getByKeyPath,u.getJSONType=function getJSONType(e){return null===e?"null":Array.isArray(e)?"array":_typeof$1(e)},u.JSON_TYPES=["null","boolean","number","string","array","object"];var y={error:{test:function test(e){return"Error"===u.toStringTag(e)},replace:function replace(e){return{name:e.name,message:e.message}},revive:function revive(e){var t=e.name,r=e.message,n=new Error(r);return n.name=t,n}}},l="undefined"==typeof self?global:self,f={};return["TypeError","RangeError","SyntaxError","ReferenceError","EvalError","URIError","InternalError"].forEach(function(e){var t=l[e];t&&(f[e.toLowerCase()]={test:function test(e){return u.hasConstructorOf(e,t)},replace:function replace(e){return e.message},revive:function revive(e){return new t(e)}})}),[y,f]});
//# sourceMappingURL=postmessage.js.map
